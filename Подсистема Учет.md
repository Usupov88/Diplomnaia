### Учёт

Все добавляемые объекты включаем в новую подсистему **Учёт**, выведенную в командный интерфейс.

1. Добавить план видов характеристик **ВидыСубконто**:
   тип значения характеристик — составной (СправочникСсылка.Контрагенты, СправочникСсылка.Номенклатура, СправочникСсылка.Сотрудники),Представление объекта — «Вид субконто»;
  
   ![Планы видов характеристик](%D0%9F%D0%BB%D0%B0%D0%BD%D1%8B%20%D0%B2%D0%B8%D0%B4%D0%BE%D0%B2%20%D1%85%D0%B0%D1%80%D0%B0%D0%BA%D1%82%D0%B5%D1%80%D0%B8%D1%81%D1%82%D0%B8%D0%BA.png)
   
  * Три предопределенных элемента:
    контрагенты (СправочникСсылка.Контрагенты),номенклатура (СправочникСсылка.Номенклатура),    сотрудники (СправочникСсылка.Сотрудники).

![Предопределённые](%D0%9F%D1%80%D0%B5%D0%B4%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D1%91%D0%BD%D0%BD%D1%8B%D0%B5.png)

2. Добавить план счетов **Управленческий**:
  длина кода — 4, наименования — 50;
  маска кода — «##.#», автопорядок по коду, ширина порядка — 4;
  добавить признак учёта **Количественный** для учёта по количеству на единственном счёте **Товары**;
  
 ![Управленческий](%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9.png)

  * в качестве видов субконто указать созданный на предыдущем шаге ПВХ **ВидыСубконто**. Максимальное количество видов субконто — 1;
   
   ![Субконто](%D0%A1%D1%83%D0%B1%D0%BA%D0%BE%D0%BD%D1%82%D0%BE.png)

  * добавить предопределённые счета:
    * активный 41 **Товары** (виды субконто: Номенклатура, учёт по количеству);
    * активный 50 **ДенежныеСредства**;
    * активно-пассивный 60 **РасчетыСПоставщиками** (виды субконто: Контрагенты);
    * активно-пассивный 62 **РасчетыСПокупателями** (виды субконто: Контрагенты);
    * активно-пассивный 70 **РасчетыССотрудниками** (виды субконто: Сотрудники);
    * активно-пассивный 90 **ПрибылиИУбытки** с субсчетами:
      * пассивный 90.1 **Выручка**;
      * активный 90.2 **Расходы**;
  
![Предопределённые счета](%D0%9F%D1%80%D0%B5%D0%B4%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D1%91%D0%BD%D0%BD%D1%8B%D0%B5%20%D1%81%D1%87%D0%B5%D1%82%D0%B0.png)

1. Добавить регистр бухгалтерии **Управленческий**:
  * с учётом по плану счетов **Управленческий**;
  * с корреспонденцией;
  
  ![Рег бух](%D0%A0%D0%B5%D0%B3%20%D0%B1%D1%83%D1%85.png)

  * с ресурсами:
    * **Сумма** (ОпределяемыйТип.Сумма);
    * **Количество** (ОпределяемыйТип.Количество) — с признаком учета **Количественный** и со снятым флажком **Балансовый**;
  
![Ресурсы](%D0%A0%D0%B5%D1%81%D1%83%D1%80%D1%81%D1%8B.png)

  * в регистраторы добавить документы:
    * **ПоступлениеТоваровИУслуг**,
    * **РеализацияТоваровИУслуг**,
    * **ПоступлениеДенежныхСредств**,
    * **СписаниеДенежныхСредств**.
  
![Регистратор](%D0%A0%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%82%D0%BE%D1%80.png)

1. Доработать обработчик проведения документа **ПоступлениеТоваровИУслуг**:
  * для строк с номенклатурой вида Товар формировать движение Дт **Товары** с заполнением субконто Номенклатура — Кт **РасчетыСПоставщиками** с заполнением субконто Контрагенты на сумму строки;
  * для строк с номенклатурой вида Услуга формировать движение Дт **Расходы** — Кт **РасчетыСПоставщиками** с заполнением субконто Контрагенты на сумму строки.

Процедура ОбработкаПроведения(Отказ, Режим)
	
	//НоваяЗапись 
	Движения.Товары.Очистить();
	Движения.Товары.Записывать = Истина;
	
	Движения.ВзаиморасчетыСКонтрагентами.Очистить(); 
	Движения.ВзаиморасчетыСКонтрагентами.Записывать=Истина;
	
	Движения.Расходы.Очистить(); 
	Движения.Расходы.Записывать=Истина;
	
	Движения.Управленческий.Очистить();
	Движения.Управленческий.Записывать = Истина;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(ПоступлениеТоваровИУслугТоварыИУслуги.Количество) КАК Количество,
	|	СУММА(ПоступлениеТоваровИУслугТоварыИУслуги.Цена) КАК Цена,
	|	СУММА(ПоступлениеТоваровИУслугТоварыИУслуги.Сумма) КАК Сумма,
	|	ПоступлениеТоваровИУслугТоварыИУслуги.Номенклатура КАК Номенклатура,
	|	ПоступлениеТоваровИУслугТоварыИУслуги.Номенклатура.Тип КАК НоменклатураТип
	|ИЗ
	|	Документ.ПоступлениеТоваровИУслуг.ТоварыИУслуги КАК ПоступлениеТоваровИУслугТоварыИУслуги
	|ГДЕ
	|	ПоступлениеТоваровИУслугТоварыИУслуги.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ПоступлениеТоваровИУслугТоварыИУслуги.Номенклатура";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	Движение = Движения.ВзаиморасчетыСКонтрагентами.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
	Движение.Период = Дата;
	Движение.Контрагент = Ссылка.Поставщик;
	Движение.Сумма = Ссылка.Сумма;
	
	Движение = Движения.Управленческий.Добавить();
	Движение.Период = Дата;
	Движение.СчетДт = ПланыСчетов.Управленческий.РассчетыСПокупателями;
	Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Контрагенты] = Поставщик;
	Движение.СчетКт = ПланыСчетов.Управленческий.Выручка;
	Движение.Сумма = Ссылка.Сумма;
	
	
	Для Каждого Строка Из Результат Цикл
		
		Движение = Движения.Товары.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.Номенклатура = Строка.Номенклатура;
		Движение.Количество = Строка.Количество;
		Движение.Сумма = Строка.Сумма;
		
		Если Строка.НоменклатураТип = Перечисления.ТипыНоменклатуры.Товар Тогда
			Движение = Движения.Управленческий.Добавить();
			Движение.Период = Дата;
			
			Движение.СчетДт = ПланыСчетов.Управленческий.Товары; 
			Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = Строка.Номенклатура;
			Движение.КоличествоДт = Строка.Количество;
				
			Движение.СчетКт = ПланыСчетов.Управленческий.РассчетыСПоставщиками;
			Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Контрагенты] = Поставщик;
			Движение.Сумма = Строка.Сумма;
			
		ИначеЕсли Строка.НоменклатураТип = Перечисления.ТипыНоменклатуры.Услуга Тогда
			Движение = Движения.Управленческий.Добавить();
			Движение.Период = Дата;
			Движение.Сумма = Строка.Сумма;
			
			Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = Строка.Номенклатура;
			Движение.СчетДт = ПланыСчетов.Управленческий.Расходы;
			
			Движение.СчетКт = ПланыСчетов.Управленческий.РассчетыСПоставщиками;
			Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Контрагенты] = Поставщик;
		КонецЕсли;
	КонецЦикла;
	  	Движения.Записать();
		
КонецПроцедуры
    
2. Доработать обработчик проведения документа **РеализацияТоваровИУслуг**:
  * формировать движение Дт **РасчетыСПокупателями** с заполнением субконто Контрагенты — Кт **Выручка** на общую сумму продажи (по всем строкам);
  * для строк с номенклатурой вида Товар формировать движение Дт **Расходы** — Кт **Товары** с заполнением субконто Номенклатура на сумму себестоимости списанного товара. Себестоимость должна рассчитываться по данным регистра бухгалтерии, а не по данным регистра накопления **Товары**. Данные регистра бухгалтерии нужно получать запросом к виртуальной таблице **РегистрБухгалтерии.Управленческий.Остатки** на МоментВремени() проводимого документа. При списании необходимо проверять, что количества товара достаточно для списания.

Процедура ОбработкаПроведения(Отказ, Режим)
	
	//НоваяЗапись 
	Движения.Товары.Записывать = Истина;
	Движения.Управленческий.Записывать = Истина;
	Движения.Записать();
	
	Движения.Товары.Записывать = Истина;
	Движения.Управленческий.Записывать = Истина;
	Движения.ВзаиморасчетыСКонтрагентами.Записывать=Истина;
	Движения.Доходы.Записывать=Истина;
	Движения.Расходы.Записывать=Истина; 
	 
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	РеализацияТоваровИУслугТовары.Номенклатура КАК Номенклатура,
	|	СУММА(РеализацияТоваровИУслугТовары.Количество) КАК Количество,
	|	РеализацияТоваровИУслугТовары.Номенклатура.Тип КАК НоменклатураТип
	|ПОМЕСТИТЬ ВТ_Товары
	|ИЗ
	|	Документ.РеализацияТоваровИУслуг.Товары КАК РеализацияТоваровИУслугТовары
	|ГДЕ
	|	РеализацияТоваровИУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровИУслугТовары.Номенклатура,
	|	РеализацияТоваровИУслугТовары.Номенклатура.Тип
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Товары.Номенклатура КАК Номенклатура,
	|	ВТ_Товары.Количество КАК Количество,
	|	ВТ_Товары.Номенклатура.Представление КАК НоменклатураПредставление,
	|	ВТ_Товары.НоменклатураТип КАК НоменклатураТип,
	|	ЕСТЬNULL(УправленческийОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
	|	ЕСТЬNULL(УправленческийОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток
	|ИЗ
	|	ВТ_Товары КАК ВТ_Товары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Управленческий.Остатки(
	|				&МоментВремени,
	|				Счет = &Товары,
	|				,
	|				Субконто1 В
	|					(ВЫБРАТЬ
	|						ВТ_Товары.Номенклатура КАК Номенклатура
	|					ИЗ
	|						ВТ_Товары КАК ВТ_Товары)) КАК УправленческийОстатки
	|		ПО ВТ_Товары.Номенклатура = УправленческийОстатки.Субконто1";
	
	
	Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
	Запрос.УстановитьПараметр("Ссылка", Ссылка); 
	Запрос.УстановитьПараметр("Товары", ПланыСчетов.Управленческий.Товары);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	// Движение по регистру накопления Взаиморасчетыс контрагентами
	Движение = Движения.ВзаиморасчетыСКонтрагентами.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Приход; 
	Движение.Период = Дата;
	Движение.Контрагент =Покупатель;
	Движение.Сумма = Ссылка.Сумма; 
	
	//Движение по регистру бухгалтерии Управленческий
	Движение = Движения.Управленческий.Добавить();
	Движение.Период = Дата;
	Движение.СчетДт = ПланыСчетов.Управленческий.РассчетыСПокупателями;
	Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Контрагенты] = Покупатель;
	
	Движение.СчетКт = ПланыСчетов.Управленческий.Выручка;
	Движение.Сумма = Ссылка.Сумма;
	
	Пока Выборка.Следующий() Цикл 
		
		Если Выборка.Количество > Выборка.КоличествоОстаток Тогда 
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = " Не хватает товара  "  +  Выборка.НоменклатураПредставление  +  "  в количестве "  +  ( Выборка.Количество - Выборка.КоличествоОстаток);
			Сообщение.Сообщить();
			
			Отказ = Истина;
			Продолжить;
		КонецЕсли;
		
		Если Выборка.Количество = Выборка.КоличествоОстаток Тогда
			Себестоимость = Выборка.СуммаОстаток;
		Иначе
			Себестоимость = Выборка.СуммаОстаток  * Выборка.Количество  /  Выборка.КоличествоОстаток ;
		КонецЕсли;
		
		//Движение по регистру накопления Товары
		Движение = Движения.Товары.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Номенклатура = Выборка.Номенклатура;
		Движение.Количество =Выборка.Количество;
		Движение.Сумма = Себестоимость; 
		
		Если Выборка.НоменклатураТип = Перечисления.ТипыНоменклатуры.Товар Тогда
			
			// Движение по регистру накопления Расходы
			Движение = Движения.Расходы.Добавить();
			Движение.Период = Дата;
			Движение.Номенклатура = Выборка.Номенклатура;
			Движение.Сумма = Сумма;
			
			Движение = Движения.Управленческий.Добавить();
			Движение.Период = Дата;
			Движение.СчетДт = ПланыСчетов.Управленческий.Расходы; 
			
			Движение.СчетКт = ПланыСчетов.Управленческий.Товары;
			Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Номенклатура] = Выборка.Номенклатура;
			Движение.Сумма = Себестоимость;
			Движение.КоличествоКт = Выборка.Количество;
			
		КонецЕсли;
		
		// Движение по регистру накопления Доходы
		Движение = Движения.Доходы.Добавить();
		Движение.Период = Дата;
		Движение.Номенклатура = Выборка.Номенклатура;
		Движение.Количество =Выборка.Количество;
		Движение.Сумма = Сумма;
		
	КонецЦикла; 
	  
 КонецПроцедуры   	


3. Доработать документ **ПоступлениеДенежныхСредств**:
  * тип реквизита **Плательщик** сделать составным и расширить его типом **СправочникСсылка.Сотрудники**;
  
![Плательщик](%D0%9F%D0%BB%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%89%D0%B8%D0%BA.png)

  * при проведении формировать движения в Дт **ДенежныеСредства** и Кт:
    * для плательщиков-контрагентов — **РасчетыСПокупателями** с заполнением субконто **Контрагенты**;
    * для плательщиков-сотрудников — **РасчетыССотрудниками** с заполнением субконто **Сотрудники**.
      
Процедура ОбработкаПроведения(Отказ, Режим)

	// регистр ВзаиморасчетыСКонтрагентами Расход
	Движения.ВзаиморасчетыСКонтрагентами.Записывать = Истина;
	Движение = Движения.ВзаиморасчетыСКонтрагентами.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
	Движение.Период = Дата;
	Движение.Контрагент = Ссылка.Плательшик;
	Движение.Сумма = Сумма;
	
	// регистр Управленческий проведение
	Движения.Управленческий.Записывать = Истина;
	Движение = Движения.Управленческий.Добавить();
	Движение.Период = Дата; 
	Движение.Сумма = Сумма;
	Движение.СчетДт = ПланыСчетов.Управленческий.ДенежныеСредства;
	
	Если ТипЗнч("Плательшик") = Тип("СправочникСсылка.Контрагенты") Тогда
		Движение.СчетКт = ПланыСчетов.Управленческий.РассчетыСПокупателями;
		Движение.СубконтоКт [ПланыВидовХарактеристик.ВидыСубконто.Контрагенты] = Плательшик;
		
	ИначеЕсли ТипЗнч("Плательшик") = Тип("СправочникСсылка.Сотрудники") Тогда
		Движение.СчетКт = ПланыСчетов.Управленческий.РассчетыССотрудниками;
		Движение.СубконтоКт [ПланыВидовХарактеристик.ВидыСубконто.Сотрудники] = Плательшик;
	КонецЕсли;

КонецПроцедуры


1. Доработать документ **СписаниеДенежныхСредств**:
  * тип реквизита **Получатель** сделать составным и расширить его типом **СправочникСсылка.Сотрудники**;

![Получатель](%D0%9F%D0%BE%D0%BB%D1%83%D1%87%D0%B0%D1%82%D0%B5%D0%BB%D1%8C.png)

  * при проведении формировать движения с Кт **ДенежныеСредства** и в Дт:
    * для получателей-контрагентов — **РасчетыСПоставщиками** с заполнением субконто **Контрагенты**;
    * для получателей-сотрудников — **РасчетыССотрудниками** с заполнением субконто **Сотрудники**.

   Процедура ОбработкаПроведения(Отказ, Режим)

	// регистр ВзаиморасчетыСКонтрагентами Приход
	Движения.ВзаиморасчетыСКонтрагентами.Записывать = Истина;
	Движение = Движения.ВзаиморасчетыСКонтрагентами.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
	Движение.Период = Дата;
	Движение.Контрагент = Ссылка.Получатель;
	Движение.Сумма = Сумма;
	
	//Регистр Управленческий проведение
	Движения.Управленческий.Записывать = Истина;
	Движение = Движения.Управленческий.Добавить();
	Движение.Период = Дата;
	Движение.Сумма = Сумма;
	Движение.СчетКт = ПланыСчетов.Управленческий.ДенежныеСредства;
	Движение.СчетДт = ПланыСчетов.Управленческий.ДенежныеСредства;
	
	Если  ТипЗнч("Получатель") = Тип("СправочникСсылка.Контрагенты") Тогда
		Движение.СчетДт = ПланыСчетов.Управленческий.РассчетыСПоставщиками;
		Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Контрагенты ] = Получатель;
		
	ИначеЕсли ТипЗнч("Получатель") = Тип("СправочникСсылка.Сотрудники") Тогда
		Движение.СчетДт = ПланыСчетов.Управленческий.РассчетыССотрудниками;
		Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Сотрудники] = Получатель;
	КонецЕсли;

КонецПроцедуры

2. Добавить отчёт **ОборотноСальдоваяВедомость** («Оборотно-сальдовая ведомость»):
  * создать основную схему компоновки данных, а в ней — набор данных-запрос;
  * в запрос конструктором добавить виртуальную таблицу **РегистрБухгалтерии.Управленческий.ОстаткиИОбороты** с параметрами &НачалоПериода и &КонецПериода;
  * в качестве полей выбрать:
    * будущие группировки **Счет** и **Субконто1**;
    * будущие ресурсы:
      * **СуммаНачальныйОстатокДт** и **СуммаНачальныйОстатокДт**,
      * **СуммаОборотДт** и **СуммаОборотКт**,
      * **СуммаКонечныйОстатокДт** и **СуммаКонечныйОстатокКт**;
  
![Набор данных сальдо](%D0%9D%D0%B0%D0%B1%D0%BE%D1%80%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20%D1%81%D0%B0%D0%BB%D1%8C%D0%B4%D0%BE.png)

  * на закладке «Ресурсы» добавить три пары ресурсов с функцией по умолчанию **Сумма** и прочими настройками по умолчанию;

![Ресурсы сальдо](%D0%A0%D0%B5%D1%81%D1%83%D1%80%D1%81%D1%8B%20%D1%81%D0%B0%D0%BB%D1%8C%D0%B4%D0%BE.png)

  * на закладке «Настройки»:
    * добавить группирровку **Счет** (с иерархией), а под ней — **Субконто1** (без иерархии);
    * добавить ресурсы, сгруппировав их в группы «Начальный остаток», «Оборот», «Конечный остаток», и дав краткие заголовки «Дт» и «Кт» вместо избыточных «СуммаНачальныйОстатокДт» и т. д.:

![Настройки сальдо](%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8%20%D1%81%D0%B0%D0%BB%D1%8C%D0%B4%D0%BE.png)

    * Параметры **НачалоПериода** и **КонецПериода** включите в пользовательские настройки с быстрым доступом;
  
  ![Период сальдо](%D0%9F%D0%B5%D1%80%D0%B8%D0%BE%D0%B4%20%D1%81%D0%B0%D0%BB%D1%8C%D0%B4%D0%BE.png)

 # Результат отчёта
![Отчет](%D0%9E%D1%82%D1%87%D0%B5%D1%82.png)